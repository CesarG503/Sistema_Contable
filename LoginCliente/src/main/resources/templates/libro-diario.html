<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libro Diario - Sistema de Contabilidad</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
</head>
<body>

<button class="mobile-menu-toggle" onclick="toggleSidebar()">☰</button>

<div th:replace="fragments/sidebar :: sidebar" ></div>

<div class="main-content">
    <div class="page-header">
        <h1>Libro Diario</h1>
        <button class="btn btn-primary" onclick="openModal()">Nueva Partida</button>
    </div>

    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-group">
                <label>Fecha inicial</label>
                <input type="date" id="fechaInicial">
            </div>
            <div class="filter-group">
                <label>Fecha final</label>
                <input type="date" id="fechaFinal">
            </div>
            <button class="btn">Filtrar</button>
        </div>
        <div class="filter-row" style="margin-top: 15px;">
            <div class="filter-group">
                <label>Número de asiento</label>
                <input type="text" placeholder="Type here..." id="numeroAsiento">
            </div>
            <button class="btn">Buscar</button>
        </div>
    </div>

    <div class="table-section">
        <div th:if="${partidasConMovimientos.isEmpty()}">
            <p style="text-align: center; color: #666; padding: 40px;">No hay partidas registradas</p>
        </div>

        <table th:if="${not partidasConMovimientos.isEmpty()}">
            <thead>
            <tr>
                <th># Asiento</th>
                <th>Fecha</th>
                <th>Descripción</th>
                <th>Debe</th>
                <th>Haber</th>
                <th>Detalles</th>
            </tr>
            </thead>
            <tbody>
            <th:block th:each="entry : ${partidasConMovimientos}">
                <tr th:each="mov, iterStat : ${entry.value}">
                    <td th:if="${iterStat.first}" th:rowspan="${entry.value.size()}" th:text="${entry.key.id_partida}"></td>
                    <td th:if="${iterStat.first}" th:rowspan="${entry.value.size()}" th:text="${entry.key.fechaFormateada}"></td>
                    <td>
                        <div th:if="${iterStat.first}" th:text="${entry.key.concepto}" style="font-weight: 600;"></div>
                        <div th:each="cuenta : ${cuentas}" th:if="${cuenta.id_cuenta == mov.id_cuenta}" th:text="${cuenta.nombre}"></div>
                    </td>
                    <td th:text="${mov.tipo == 'D' ? '$' + mov.monto : ''}"></td>
                    <td th:text="${mov.tipo == 'H' ? '$' + mov.monto : ''}"></td>
                    <td th:if="${iterStat.first}" th:rowspan="${entry.value.size()}">
                        <button class="btn-details">Ver detalles →</button>
                    </td>
                </tr>
            </th:block>
            </tbody>
        </table>
    </div>
</div>

<div id="partidaModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Nueva Partida Contable</h2>

        <form id="partidaForm">
            <div class="form-group">
                <label for="concepto">Concepto:</label>
                <textarea id="concepto" rows="3" required></textarea>
            </div>

            <div class="movimientos-container">
                <h3>Movimientos</h3>
                <div id="movimientos">

                    <div class="movimiento-row">
                        <div class="form-group">
                            <label>Cuenta:</label>
                            <select class="cuenta-select" required>
                                <option value="">Seleccione una cuenta</option>
                                <option th:each="cuenta : ${cuentas}" th:value="${cuenta.id_cuenta}" th:text="${cuenta.nombre}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Monto:</label>
                            <input type="number" class="monto-input" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo:</label>
                            <select class="tipo-select" required>
                                <option value="D">Debe</option>
                                <option value="H">Haber</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-remove" onclick="removeMovimiento(this)">X</button>
                    </div>

                    <div class="movimiento-row">
                        <div class="form-group">
                            <label>Cuenta:</label>
                            <select class="cuenta-select" required>
                                <option value="">Seleccione una cuenta</option>
                                <option th:each="cuenta : ${cuentas}" th:value="${cuenta.id_cuenta}" th:text="${cuenta.nombre}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Monto:</label>
                            <input type="number" class="monto-input" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo:</label>
                            <select class="tipo-select" required >
                                <option value="D">Debe</option>
                                <option value="H" selected >Haber</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-remove" onclick="removeMovimiento(this)">X</button>
                    </div>


                </div>


                <button type="button" class="btn btn-add" onclick="addMovimiento()">Agregar Movimiento</button>

                <div class="totales">
                    <div class="total-item">
                        <span>Total Debe:</span>
                        <strong id="totalDebe">$0.00</strong>
                    </div>
                    <div class="total-item">
                        <span>Total Haber:</span>
                        <strong id="totalHaber">$0.00</strong>
                    </div>
                    <div class="total-item">
                        <span>Diferencia:</span>
                        <strong id="diferencia">$0.00</strong>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Guardar Partida</button>
        </form>
    </div>
</div>
<script th:src="@{/js/Sidebar.js}"></script>
<script th:src="@{/js/Diario.js}"></script>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libro Diario - Sistema de Contabilidad</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>

<button class="mobile-menu-toggle" onclick="toggleSidebar()">â˜°</button>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="logo">
            <div class="logo-icon">ðŸ’§</div>
            <span>OneDi</span>
        </div>
    </div>

    <div class="sidebar-menu">
        <div class="menu-section">
            <div class="menu-title">MENU</div>
            <a href="/usuarios/home" class="menu-item">
                <div class="menu-icon">ðŸ“Š</div>
                <span>Dashboard</span>
            </a>
            <a href="/partidas/libro-diario" class="menu-item active">
                <div class="menu-icon">ðŸ“–</div>
                <span>Libro Diario</span>
            </a>
            <a href="/cuentas/libro-mayor" class="menu-item">
                <div class="menu-icon">ðŸ“‘</div>
                <span>Cuentas T</span>
            </a>
            <a href="/cuentas/crear" class="menu-item">
                <div class="menu-icon">âž•</div>
                <span>Crear Cuenta</span>
            </a>
        </div>

        <div class="menu-section">
            <div class="menu-title">PREFERENCIAS</div>
            <a href="#" class="menu-item">
                <div class="menu-icon">ðŸŒ™</div>
                <span>Tema</span>
            </a>
        </div>
    </div>

    <div class="sidebar-footer">
        <div class="user-profile">
            <div class="user-avatar">OD</div>
            <div class="user-info">
                <div class="user-name">ONE D</div>
                <div class="user-email">usuario@email.com</div>
            </div>
        </div>
    </div>
</div>

<div class="main-content">
    <div class="page-header">
        <h1>Libro Diario</h1>
        <button class="btn btn-primary" onclick="openModal()">Nueva Partida</button>
    </div>

    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-group">
                <label>Fecha inicial</label>
                <input type="date" id="fechaInicial">
            </div>
            <div class="filter-group">
                <label>Fecha final</label>
                <input type="date" id="fechaFinal">
            </div>
            <button class="btn">Filtrar</button>
        </div>
        <div class="filter-row" style="margin-top: 15px;">
            <div class="filter-group">
                <label>NÃºmero de asiento</label>
                <input type="text" placeholder="Type here..." id="numeroAsiento">
            </div>
            <button class="btn">Buscar</button>
        </div>
    </div>

    <div class="table-section">
        <div th:if="${partidasConMovimientos.isEmpty()}">
            <p style="text-align: center; color: #666; padding: 40px;">No hay partidas registradas</p>
        </div>

        <table th:if="${!partidasConMovimientos.isEmpty()}">
            <thead>
            <tr>
                <th># Asiento</th>
                <th>Fecha</th>
                <th>DescripciÃ³n</th>
                <th>Debe</th>
                <th>Haber</th>
                <th>Detalles</th>
            </tr>
            </thead>
            <tbody>
            <th:block th:each="entry : ${partidasConMovimientos}">
                <tr th:each="mov, iterStat : ${entry.value}">
                    <td th:if="${iterStat.first}" th:rowspan="${entry.value.size()}" th:text="${entry.key.id_partida}"></td>
                    <td th:if="${iterStat.first}" th:rowspan="${entry.value.size()}" th:text="${#temporals.format(entry.key.fecha, 'dd/MM/yyyy')}"></td>
                    <td>
                        <div th:if="${iterStat.first}" th:text="${entry.key.concepto}" style="font-weight: 600;"></div>
                        <div th:text="${cuentas.stream().filter(c -> c.id_cuenta == mov.id_cuenta).findFirst().orElse(new com.example.LoginCliente.Models.Cuenta()).nombre}"></div>
                    </td>
                    <td th:text="${mov.tipo == 'D' ? '$' + mov.monto : ''}"></td>
                    <td th:text="${mov.tipo == 'H' ? '$' + mov.monto : ''}"></td>
                    <td th:if="${iterStat.first}" th:rowspan="${entry.value.size()}">
                        <button class="btn-details">Ver detalles â†’</button>
                    </td>
                </tr>
            </th:block>
            </tbody>
        </table>
    </div>
</div>

<div id="partidaModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Nueva Partida Contable</h2>

        <form id="partidaForm">
            <div class="form-group">
                <label for="concepto">Concepto:</label>
                <textarea id="concepto" rows="3" required></textarea>
            </div>

            <div class="movimientos-container">
                <h3>Movimientos</h3>
                <div id="movimientos">
                    <div class="movimiento-row">
                        <div class="form-group">
                            <label>Cuenta:</label>
                            <select class="cuenta-select" required>
                                <option value="">Seleccione una cuenta</option>
                                <option th:each="cuenta : ${cuentas}" th:value="${cuenta.id_cuenta}" th:text="${cuenta.nombre}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Monto:</label>
                            <input type="number" class="monto-input" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo:</label>
                            <select class="tipo-select" required>
                                <option value="D">Debe</option>
                                <option value="H">Haber</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-remove" onclick="removeMovimiento(this)">X</button>
                    </div>
                </div>
                <button type="button" class="btn btn-add" onclick="addMovimiento()">Agregar Movimiento</button>

                <div class="totales">
                    <div class="total-item">
                        <span>Total Debe:</span>
                        <strong id="totalDebe">$0.00</strong>
                    </div>
                    <div class="total-item">
                        <span>Total Haber:</span>
                        <strong id="totalHaber">$0.00</strong>
                    </div>
                    <div class="total-item">
                        <span>Diferencia:</span>
                        <strong id="diferencia">$0.00</strong>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Guardar Partida</button>
        </form>
    </div>
</div>

<script>
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
    }

    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('sidebar');
        const toggle = document.querySelector('.mobile-menu-toggle');

        if (window.innerWidth <= 768 &&
            !sidebar.contains(event.target) &&
            !toggle.contains(event.target) &&
            sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
        }
    });

    function openModal() {
        document.getElementById('partidaModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('partidaModal').style.display = 'none';
        document.getElementById('partidaForm').reset();
    }

    function addMovimiento() {
        const container = document.getElementById('movimientos');
        const firstRow = container.querySelector('.movimiento-row');
        const newRow = firstRow.cloneNode(true);
        newRow.querySelectorAll('input, select').forEach(input => input.value = '');
        container.appendChild(newRow);
        attachCalculateListeners();
    }

    function removeMovimiento(btn) {
        const container = document.getElementById('movimientos');
        if (container.querySelectorAll('.movimiento-row').length > 1) {
            btn.closest('.movimiento-row').remove();
            calculateTotals();
        }
    }

    function calculateTotals() {
        let totalDebe = 0;
        let totalHaber = 0;

        document.querySelectorAll('.movimiento-row').forEach(row => {
            const monto = parseFloat(row.querySelector('.monto-input').value) || 0;
            const tipo = row.querySelector('.tipo-select').value;

            if (tipo === 'D') {
                totalDebe += monto;
            } else if (tipo === 'H') {
                totalHaber += monto;
            }
        });

        document.getElementById('totalDebe').textContent = '$' + totalDebe.toFixed(2);
        document.getElementById('totalHaber').textContent = '$' + totalHaber.toFixed(2);
        document.getElementById('diferencia').textContent = '$' + Math.abs(totalDebe - totalHaber).toFixed(2);
    }

    function attachCalculateListeners() {
        document.querySelectorAll('.monto-input, .tipo-select').forEach(element => {
            element.removeEventListener('input', calculateTotals);
            element.addEventListener('input', calculateTotals);
        });
    }

    attachCalculateListeners();

    document.getElementById('partidaForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const concepto = document.getElementById('concepto').value;
        const movimientos = [];

        document.querySelectorAll('.movimiento-row').forEach(row => {
            const idCuenta = row.querySelector('.cuenta-select').value;
            const monto = row.querySelector('.monto-input').value;
            const tipo = row.querySelector('.tipo-select').value;

            if (idCuenta && monto && tipo) {
                movimientos.push({ idCuenta, monto, tipo });
            }
        });

        try {
            const response = await fetch('/partidas/crear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ concepto, movimientos })
            });

            const data = await response.json();

            if (response.ok) {
                alert('Partida creada exitosamente');
                location.reload();
            } else {
                alert(data.error || 'Error al crear la partida');
            }
        } catch (error) {
            alert('Error al crear la partida: ' + error.message);
        }
    });
</script>
</body>
</html>
